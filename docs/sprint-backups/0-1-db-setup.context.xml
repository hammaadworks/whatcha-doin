<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>0.1</storyId>
    <title>DB Setup</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-1-db-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to create and commit the initial database schema migrations for all core entities</iWant>
    <soThat>the database is ready for application development</soThat>
    <tasks>
- [ ] Task 1 (AC: #1, #2, #3, #4)
  - [ ] Subtask 1.1: Draft the SQL for the `users` table, including profile information.
  - [ ] Subtask 1.2: Draft the SQL for the `habits` and `habit_completions` tables.
  - [ ] Subtask 1.3: Draft the SQL for the `todos` table, including the self-referencing `parent_todo_id`.
  - [ ] Subtask 1.4: Draft the SQL for the `journal_entries` table.
- [ ] Task 2 (AC: #5)
  - [ ] Subtask 2.1: Define default RLS policies for all user-data tables, ensuring users can only access their own data.
- [ ] Task 3 (AC: #6)
  - [ ] Subtask 3.1: Create a new migration using the Supabase CLI.
  - [ ] Subtask 3.2: Apply the migration to the local development database to verify it.
    </tasks>
  </story>

  <acceptanceCriteria>
1.  A new Supabase migration file is created in the `supabase/migrations` directory.
2.  The migration includes `CREATE TABLE` statements for `users`, `habits`, `habit_completions`, `todos`, and `journal_entries`.
3.  All table and column names adhere to the `snake_case` naming convention specified in the architecture.
4.  Primary keys, foreign keys, and appropriate constraints (e.g., `NOT NULL`) are defined for all tables.
5.  Row Level Security (RLS) is enabled for all tables containing user-specific data.
6.  The migration successfully runs without errors in a local Supabase environment.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Architecture</section>
        <snippet>The data architecture will be built upon Supabase PostgreSQL, leveraging its relational capabilities to ensure data integrity and support complex queries. Data models will be designed to reflect the core entities of the application: users, habits, todos, and journal entries.</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing code artifacts relevant to this story -->
    </code>
    <dependencies>
      <ecosystem name="npm">
        <package name="package.json" version="not-found" />
      </ecosystem>
      <notes>This story is a database migration and has no direct code dependencies.</notes>
    </dependencies>
  </artifacts>

  <constraints>
    - Implementation must be a Supabase migration file.
    - The migration file must be created in the `supabase/migrations` directory.
    - All database table and column names must use `snake_case`.
  </constraints>
  <interfaces>
      <!-- No existing interfaces to be consumed by this story -->
  </interfaces>
  <tests>
    <standards>
      The testing strategy follows the lean MVP approach defined in the architecture document. For this story, the primary validation is not through unit or E2E tests, but by successfully applying the migration to a local Supabase instance.
      [Source: `docs/architecture.md#Testing-Strategy`]
    </standards>
    <locations>
      - `tests/integration` for future integration tests against the database schema.
    </locations>
    <ideas>
      - (AC: #6) Manually run `supabase db reset` or a similar command to apply the new migration and ensure it completes without errors.
      - (AC: #5) Write a simple integration test (using Vitest) to connect to the test database and verify that the RLS policies for the `users` table are active and prevent cross-user data access.
    </ideas>
  </tests>
</story-context>
