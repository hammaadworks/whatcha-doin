<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>Delete Habit</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-3-delete-habit.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to delete a habit from "The Pile"</iWant>
    <soThat>I can permanently remove activities I'm no longer tracking.</soThat>
    <tasks>
-   [ ] **Task 1: Implement Habit Deletion UI** (AC: #1, #2)
    -   [ ] Subtask 1.1: Modify `HabitCard.tsx` to include a delete button/icon, visible only when the habit is in "The Pile".
    -   [ ] Subtask 1.2: Implement a confirmation dialog before permanent deletion.
-   [ ] **Task 2: Implement Habit Deletion Service** (AC: #1, #3)
    -   [ ] Subtask 2.1: Add `deleteHabit` method to `lib/supabase/habit.ts` to send a `DELETE` request to Supabase.
    -   [ ] Subtask 2.2: Ensure `deleteHabit` includes logic to verify the habit's `pile_state` before deletion (server-side validation).
-   [ ] **Task 3: Integrate Deletion Logic with UI** (AC: #1)
    -   [ ] Subtask 3.1: Update `hooks/useHabits.ts` to call `HabitService.deleteHabit` and manage state.
    -   [ ] Subtask 3.2: Implement optimistic UI updates for habit deletion.
    -   [ ] Subtask 3.3: Handle error states and display feedback using `react-hot-toast`.
-   [ ] **Task 4: Testing** (AC: #1, #2, #3)
    -   [ ] Subtask 4.1: Write unit tests for `HabitService.deleteHabit`.
    -   [ ] Subtask 4.2: Write integration tests to verify RLS policies for habit deletion and `pile_state` validation.
    -   [ ] Subtask 4.3: Write E2E tests using Playwright for the habit deletion flow, including attempts to delete from incorrect columns.
</tasks>
  </story>

  <acceptanceCriteria>
1.  Given a user is logged in and has habits, when they attempt to delete a habit from "The Pile", then the habit is successfully removed from the UI and the database.
2.  Given a user is logged in and has habits, when they attempt to delete a habit that is not in "The Pile" (e.g., in "Today" or "Yesterday"), then the delete operation is prevented or disabled in the UI.
3.  Given a user is logged in and has habits, when they attempt to delete a habit they do not own, then the operation is rejected by the server due to RLS.
</acceptanceCriteria>

  <artifacts>
    <docs></docs>
    <code></code>
    <dependencies></dependencies>
  </artifacts>

  <constraints></constraints>
  <interfaces></interfaces>
  <tests>
    <standards></standards>
    <locations></locations>
    <ideas></ideas>
  </tests>
</story-context>
