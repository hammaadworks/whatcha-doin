<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Public Profile</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-public-profile.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>a shareable public profile page that displays my bio, public habits, public todos, and public journal entries</iWant>
    <soThat>I can share my progress and journey with others</soThat>
    <tasks>
- [ ] **Task 1: Extend User Profile Service (Backend)** (AC: #2, #3, #4, #5, #8)
    - [ ] Subtask 1.1: In `lib/supabase/user.ts`, create a function `getPublicProfileData(userId)` that fetches the user's bio and all public habits, todos, and journal entries.
    - [ ] Subtask 1.2: Ensure the Supabase queries in this function filter for items where `is_public = true`.
- [ ] **Task 2: Create Public Profile Page (Frontend)** (AC: #1, #2, #3, #4, #5, #6, #7)
    - [ ] Subtask 2.1: Create the dynamic route and page at `app/(main)/profile/[userId]/page.tsx`.
    - [ ] Subtask 2.2: This page should be a server component that fetches the public profile data using the `getPublicProfileData` function.
    - [ ] Subtask 2.3: Create a component `components/profile/PublicProfileView.tsx` to display the profile data passed from the page.
    - [ ] Subtask 2.4: Implement the UI to display the bio.
    - [ ] Subtask 2.5: Implement the UI to display the list of public habits.
    - [ ] Subtask 2.6: Implement the UI to display the list of public todos.
    - [ ] Subtask 2.7: Implement the UI to display the public journal entries.
    - [ ] Subtask 2.8: Handle the case where lists are empty and display an appropriate message.
- [ ] **Task 3: Testing**
    - [ ] Subtask 3.1: Write an integration test for the `getPublicProfileData` function to ensure it only fetches public data.
    - [ ] Subtask 3.2: Write an E2E test with Playwright that navigates to a public profile URL and verifies that the bio and other public information are correctly displayed.
    </tasks>
  </story>

  <acceptanceCriteria>
1.  A public profile page is accessible at a URL structure of `/profile/[userId]`.
2.  The page correctly fetches and displays the user's bio.
3.  The page correctly fetches and displays a list of the user's public habits.
4.  The page correctly fetches and displays a list of the user's public todos.
5.  The page correctly fetches and displays the user's public journal entries.
6.  If a user has no public items of a certain type (e.g., no public habits), a message indicating this is shown instead of an empty list.
7.  The page is server-side rendered (SSR) or statically generated (SSG) to ensure fast initial load times.
8.  Data fetching for the page must only retrieve public data and be protected by Row Level Security.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-1.4, FR-1.5</section>
        <snippet>Each user must have a public profile page accessible via a shareable, unique URL that displays the user's bio, all public habits, all public todos, and the public journal.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Performance Considerations</section>
        <snippet>Next.js allows for Server-Side Rendering (SSR) or Static Site Generation (SSG) of public profile pages, ensuring fast initial load times.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics &amp; Stories</title>
        <section>Epic 1: User &amp; Profile Management</section>
        <snippet>Story 1.4 (Public Profile): As a user, I want a shareable public profile page that displays my bio, public habits, public todos, and public journal entries so that I can share my progress and journey with others.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-3-bio.md</path>
        <title>Story 1.3: Bio</title>
        <section>Dev Notes</section>
        <snippet>The previous story established the foundation for user profile management, including the `lib/supabase/user.ts` service.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/supabase/client.ts</path>
        <kind>service</kind>
        <symbol>supabase</symbol>
        <lines>1-11</lines>
        <reason>The Supabase client, which should be used for all database operations.</reason>
      </artifact>
      <artifact>
        <path>lib/supabase/user.ts</path>
        <kind>service</kind>
        <symbol>getUserProfile, updateUserBio</symbol>
        <lines>*</lines>
        <reason>The existing user service that will be extended with `getPublicProfileData`.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <name>next</name>
        <version>16.0.2</version>
      </dependency>
      <dependency>
        <name>react</name>
        <version>19.2.0</version>
      </dependency>
      <dependency>
        <name>@supabase/supabase-js</name>
        <version>^2.81.1</version>
      </dependency>
      <dependency>
        <name>vitest</name>
        <version>^4.0.8</version>
      </dependency>
      <dependency>
        <name>@playwright/test</name>
        <version>^1.56.1</version>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
- The public profile page should be rendered using Next.js SSR or SSG.
- Data fetching must respect Row Level Security policies to only show public data.
- The page should be a server component.
- Data fetching logic should be encapsulated in the `lib/supabase/user.ts` service.
  </constraints>
  <interfaces>
      <interface>
        <name>getPublicProfileData</name>
        <kind>function</kind>
        <signature>getPublicProfileData(userId: string): Promise&lt;{ data: PublicProfile | null, error: Error | null }&gt;</signature>
        <path>lib/supabase/user.ts</path>
      </interface>
  </interfaces>
  <tests>
    <standards>
      Unit tests with Vitest and React Testing Library. Integration tests with Vitest. E2E tests with Playwright.
    </standards>
    <locations>
      - tests/unit/
      - tests/integration/
      - tests/e2e/
    </locations>
    <ideas>
      - (AC: #8) Write an integration test for the `getPublicProfileData` function to ensure it only fetches public data.
      - (AC: #1, #2, #3, #4, #5) Write an E2E test that navigates to a public profile URL and verifies that the bio and other public information are correctly displayed.
    </ideas>
  </tests>
</story-context>
