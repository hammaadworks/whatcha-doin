<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.1</storyId>
    <title>Sign-up</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-1-sign-up.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>new user</asA>
    <iWant>to sign up with a magic link sent to my email</iWant>
    <soThat>I can create a secure account without needing to remember a password</soThat>
    <tasks>
- [ ] Task 1: UI Development (AC: #1, #3)
  - [ ] Subtask 1.1: Create the `Auth UI Component` (`components/auth/Login.tsx`) with an email input field and a submit button.
  - [ ] Subtask 1.2: Implement the display of a confirmation message after form submission.
- [ ] Task 2: Authentication Logic (AC: #2, #5)
  - [ ] Subtask 2.1: Implement the client-side logic to call `supabase.auth.signInWithOtp` with the user's email.
  - [ ] Subtask 2.2: Handle the authentication callback and session management after the user clicks the Magic Link.
- [ ] Task 3: Backend & Database (AC: #6, #7)
  - [ ] Subtask 3.1: Verify that the Supabase trigger to create a `public.users` record from `auth.users` is working as expected.
- [ ] Subtask 3.2: Ensure RLS policies are correctly applied for new user creation.
- [ ] Task 4: Testing (AC: #1, #2, #3, #4, #5, #6, #7)
  - [ ] Subtask 4.1: Write an integration test to verify the complete sign-up flow.
  - [ ] Subtask 4.2: Write an E2E test (Playwright) for the "golden path" of user sign-up.
    </tasks>
  </story>

  <acceptanceCriteria>
1.  A user can enter their email address into a designated sign-up form.
2.  Upon submission, the system calls the `supabase.auth.signInWithOtp` method.
3.  A confirmation message is displayed to the user, instructing them to check their email.
4.  The user receives an email containing a single-use Magic Link.
5.  Clicking the Magic Link authenticates the user and redirects them to the application's main dashboard.
6.  A new user record is created in the `auth.users` table.
7.  A corresponding user record is created in the `public.users` table, linked to the `auth.users` record.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User &amp; Profile Management</title>
        <section>Detailed Design</section>
        <snippet>This section details the services, data models, APIs, and workflows for user and profile management.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics &amp; Stories for whatcha-doin</title>
        <section>Epic 1: User &amp; Profile Management</section>
        <snippet>Focus: Establish user identity, authentication, and public presence. Stories: Story 1.1 (Sign-up): As a new user, I want to sign up with a magic link sent to my email so that I can create a secure account without needing to remember a password.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>whatcha-doin - Product Requirements Document</title>
        <section>FR-1: User &amp; Profile Management</section>
        <snippet>FR-1.1: Users must be able to create an account using a Magic Link sent to their email address.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Authentication</section>
        <snippet>Supabase Auth (Magic Link) is used for authentication. Built-in with Supabase, supports Magic Link as required, simplifies auth implementation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>components/auth/Login.tsx</path>
        <kind>component</kind>
        <symbol>Login</symbol>
        <reason>UI component for user sign-up/login.</reason>
      </artifact>
      <artifact>
        <path>hooks/useAuth.ts</path>
        <kind>hook</kind>
        <symbol>useAuth</symbol>
        <reason>Potential location for authentication logic.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="npm">
        <package name="package.json" version="not-found" />
        <notes>Key packages like `@supabase/supabase-js`, `next`, `react`, `tailwindcss`, `shadcn/ui`, and `zod` will be installed during project initialization.</notes>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    - The main UI component for authentication should be located at `components/auth/Login.tsx`.
    - Authentication logic should be handled within the component or a dedicated hook (`hooks/useAuth.ts`).
    - Implementation must strictly follow the design outlined in the Epic 1 Technical Specification.
  </constraints>
  <interfaces>
      <interface>
        <name>Supabase signInWithOtp</name>
        <kind>function signature</kind>
        <signature>supabase.auth.signInWithOtp({ email: string, options?: { emailRedirectTo?: string } }): Promise&lt;{ data: { user: User | null; session: Session | null }; error: AuthError | null }&gt;</signature>
        <path>@supabase/supabase-js</path>
      </interface>
  </interfaces>
  <tests>
    <standards>
      The testing strategy for this epic will follow the lean MVP approach defined in the architecture. This includes Unit, Integration, and E2E tests.
      [Source: `docs/architecture.md#Testing-Strategy`]
    </standards>
    <locations>
      - `tests/unit` for UI component tests.
      - `tests/integration` for authentication flow tests.
      - `tests/e2e` for end-to-end user journey tests.
    </locations>
    <ideas>
      - (AC: #1, #3) Unit test the `Auth UI Component` to ensure it renders correctly and handles user input.
      - (AC: #2, #5, #6, #7) Integration test the full sign-up flow by calling the Supabase client, mocking email delivery, and verifying user creation and authentication.
      - (AC: #1, #2, #3, #4, #5, #6, #7) E2E test the "golden path" of user sign-up using Playwright.
    </ideas>
  </tests>
</story-context>
