<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Bio</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-bio.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to edit a simple text bio in my profile</iWant>
    <soThat>I can personalize my public page</soThat>
    <tasks>
- [ ] **Task 1: Create User Profile Service (Backend)** (AC: #5)
    - [ ] Subtask 1.1: Create a new file `lib/supabase/user.ts`.
    - [ ] Subtask 1.2: Implement a function `getUserProfile(userId)` that fetches a user's profile from the `users` table.
    - [ ] Subtask 1.3: Implement a function `updateUserBio(userId, bio)` that updates the `bio` for a given user in the `users` table.
- [ ] **Task 2: Create Profile Editing Page (Frontend)** (AC: #1, #2, #3, #4)
    - [ ] Subtask 2.1: Create a new route and page at `app/(main)/profile/edit/page.tsx`.
    - [ ] Subtask 2.2: On this page, fetch the current user's profile data using the `getUserProfile` service function.
    - [ ] Subtask 2.3: Create a form component `components/profile/EditBioForm.tsx` that takes the user's current bio as a prop.
    - [ ] Subtask 2.4: The form should contain a textarea and a "Save" button.
    - [ ] Subtask 2.5: Implement the logic to call the `updateUserBio` service function when the form is submitted.
- [ ] **Task 3: Implement User Feedback** (AC: #6)
    - [ ] Subtask 3.1: Integrate a toast notification library (if not already present) to show a success message upon successful bio update.
- [ ] **Task 4: Verify Public Profile** (AC: #7)
    - [ ] Subtask 4.1: Ensure the public profile page at `app/(main)/profile/[userId]/page.tsx` is correctly fetching and displaying the bio from the `users` table.
- [ ] **Task 5: Testing**
    - [ ] Subtask 5.1: Write an integration test for the `updateUserBio` function to ensure it correctly updates the database.
    - [ ] Subtask 5.2: Write an E2E test using Playwright that navigates to the edit profile page, changes the bio, saves it, and verifies the change is reflected on the public profile page.
    </tasks>
  </story>

  <acceptanceCriteria>
1.  An authenticated user can navigate to a dedicated profile editing page.
2.  The profile editing page must display a form with a textarea for the user's bio.
3.  The textarea should be pre-filled with the user's existing bio, if any.
4.  A user can modify the text in the bio textarea and save the changes.
5.  Upon saving, the new bio is successfully persisted to the `bio` column in the `users` table in the database.
6.  The user receives clear feedback (e.g., a toast notification) that their bio has been updated successfully.
7.  The public profile page at `/profile/[userId]` correctly displays the updated bio.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-1.3</section>
        <snippet>Users must be able to edit a simple text bio for their profile.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Architecture</section>
        <snippet>Users: Will store user authentication details (managed by Supabase Auth) and profile information (e.g., user_id, email, bio, timezone, grace_screen_shown_for_date).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics &amp; Stories</title>
        <section>Epic 1: User &amp; Profile Management</section>
        <snippet>Story 1.3 (Bio): As a user, I want to edit a simple text bio in my profile so that I can personalize my public page.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-2-authentication.md</path>
        <title>Story 1.2: Authentication</title>
        <section>Dev Notes</section>
        <snippet>The previous story established the authentication flow and state management, which is a prerequisite for this story.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/supabase/client.ts</path>
        <kind>service</kind>
        <symbol>supabase</symbol>
        <lines>1-11</lines>
        <reason>The Supabase client, which should be used for all database operations.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <name>next</name>
        <version>16.0.2</version>
      </dependency>
      <dependency>
        <name>react</name>
        <version>19.2.0</version>
      </dependency>
      <dependency>
        <name>@supabase/supabase-js</name>
        <version>^2.81.1</version>
      </dependency>
      <dependency>
        <name>vitest</name>
        <version>^4.0.8</version>
      </dependency>
      <dependency>
        <name>@playwright/test</name>
        <version>^1.56.1</version>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
- All user data, including the bio, is stored in the `public.users` table in Supabase.
- Updates must be performed via the Supabase client, which respects the table's Row Level Security policies.
- The profile editing interface should be distinct from the public view of the profile.
- This feature must only be accessible to authenticated users.
  </constraints>
  <interfaces>
      <interface>
        <name>updateUserBio</name>
        <kind>function</kind>
        <signature>updateUserBio(userId: string, bio: string): Promise&lt;{ error: Error | null }&gt;</signature>
        <path>lib/supabase/user.ts</path>
      </interface>
      <interface>
        <name>getUserProfile</name>
        <kind>function</kind>
        <signature>getUserProfile(userId: string): Promise&lt;{ data: UserProfile | null, error: Error | null }&gt;</signature>
        <path>lib/supabase/user.ts</path>
      </interface>
  </interfaces>
  <tests>
    <standards>
      Unit tests with Vitest and React Testing Library. Integration tests with Vitest. E2E tests with Playwright.
    </standards>
    <locations>
      - tests/unit/
      - tests/integration/
      - tests/e2e/
    </locations>
    <ideas>
      - (AC: #5) Write an integration test for the `updateUserBio` function.
      - (AC: #7) Write an E2E test that edits the bio and verifies the change on the public profile.
    </ideas>
  </tests>
</story-context>
