<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
    <metadata>
        <epicId>1</epicId>
        <storyId>2</storyId>
        <title>Implement Development Login Bypass</title>
        <status>ready-for-dev</status>
        <generatedAt>2025-11-22</generatedAt>
        <generator>BMAD Story Context Workflow</generator>
        <sourceStoryPath>
            /Users/alhamdulillah/codespace/whatcha-doin/docs/sprint-artifacts/1-2-implement-development-login-bypass.md
        </sourceStoryPath>
    </metadata>

    <story>
        <asA>developer,</asA>
        <iWant>to bypass the full Supabase login flow during local development,</iWant>
        <soThat>I can quickly test core features using a predefined user session without repeated logins.</soThat>
        <tasks>
            <task id="1">
                <description>Implement AuthProvider for Development Bypass</description>
                <acceptance-criteria-refs>AC: #1, #2, #3, #5</acceptance-criteria-refs>
                <subtask id="1.1">
                    <description>Create or modify `components/auth/AuthProvider.tsx` to conditionally inject a mock
                        `user_id` based on an environment variable (`NEXT_PUBLIC_DEV_MODE_ENABLED`).
                    </description>
                </subtask>
                <subtask id="1.2">
                    <description>When `NEXT_PUBLIC_DEV_MODE_ENABLED=true`, set the `user_id` to
                        "68be1abf-ecbe-47a7-bafb-46be273a2e" for Supabase client interactions.
                    </description>
                </subtask>
                <subtask id="1.3">
                    <description>Ensure `supabase.auth.getSession()` or similar client-side authentication checks
                        reflect this mock session.
                    </description>
                </subtask>
                <subtask>
                    <description>Testing: Unit tests for AuthProvider logic. Integration tests to verify Supabase client
                        uses the mock `user_id`.
                    </description>
                </subtask>
            </task>
            <task id="2">
                <description>Conditionally Render Authentication Components</description>
                <acceptance-criteria-refs>AC: #4</acceptance-criteria-refs>
                <subtask id="2.1">
                    <description>Modify `app/(main)/layout.tsx` to wrap its content with `AuthProvider`.</description>
                </subtask>
                <subtask id="2.2">
                    <description>Adjust `components/auth/Auth.tsx` and `components/auth/Logins.tsx` (or other relevant
                        authentication UI components) to conditionally render based on `NEXT_PUBLIC_DEV_MODE_ENABLED` or
                        the presence of a real authenticated session versus the mock session.
                    </description>
                </subtask>
                <subtask>
                    <description>Testing: E2E tests to verify authentication UI is bypassed in development mode.
                    </description>
                </subtask>
            </task>
            <task id="3">
                <description>Update `lib/supabase/client.ts` to use injected `user_id`</description>
                <acceptance-criteria-refs>AC: #3, #5</acceptance-criteria-refs>
                <subtask id="3.1">
                    <description>Ensure that the Supabase client initialization or subsequent data access functions
                        correctly utilize the `user_id` provided by the `AuthProvider` when in development mode.
                    </description>
                </subtask>
                <subtask>
                    <description>Testing: Integration tests for data operations using the mock `user_id`.</description>
                </subtask>
            </task>
            <task id="4">
                <description>Environment Variable Setup</description>
                <acceptance-criteria-refs>AC: #1</acceptance-criteria-refs>
                <subtask id="4.1">
                    <description>Document the `NEXT_PUBLIC_DEV_MODE_ENABLED` environment variable in
                        `.env.local.example` and `README.md`.
                    </description>
                </subtask>
                <subtask>
                    <description>Testing: Manual verification of environment variable usage.</description>
                </subtask>
            </task>
        </tasks>
    </story>

    <acceptanceCriteria>
        <criterion id="1">
            <description>Given the application is in local development mode (`NEXT_PUBLIC_DEV_MODE_ENABLED=true` is
                set)
            </description>
        </criterion>
        <criterion id="2">
            <description>When the application loads</description>
        </criterion>
        <criterion id="3">
            <description>Then the user session is automatically initialized with the following predefined dummy user,
                and this `user_id` is used for all user-specific data operations (read/write):
                ```json
                {
                "id": "68be1abf-ecbe-47a7-bafb-46be273a2e",
                "email": "hammaadworks@gmail.com"
                }
                ```
            </description>
        </criterion>
        <criterion id="4">
            <description>And the existing authentication components (e.g., `Auth.tsx`, `Logins.tsx`) are either bypassed
                or conditionally rendered to prevent interference with the development bypass.
            </description>
        </criterion>
        <criterion id="5">
            <description>And the application functions as if a user with the specified `user_id` is logged in, allowing
                interaction with Supabase tables.
            </description>
        </criterion>
    </acceptanceCriteria>

    <artifacts>
        <docs>
            <artifact>
                <path>docs/PRD.md</path>
                <title>whatcha-doin - Product Requirements Document</title>
                <section>Executive Summary</section>
                <snippet>For development purposes, Supabase authentication is temporarily bypassed. The application is
                    configured to directly interact with Supabase tables using a hardcoded test user's `user_id` for all
                    feature development. This is achieved by injecting the `user_id` via the `AuthProvider` component in
                    `app/(main)/layout.tsx` when `NEXT_PUBLIC_DEV_MODE_ENABLED=true`. Full Supabase authentication will
                    be integrated in the final epic.
                </snippet>
            </artifact>
            <artifact>
                <path>docs/architecture.md</path>
                <title>Architecture</title>
                <section>Executive Summary</section>
                <snippet>For development purposes, Supabase authentication is temporarily bypassed. The application is
                    configured to directly interact with Supabase tables using a hardcoded test user's `user_id` for all
                    feature development. This is achieved by injecting the `user_id` via the `AuthProvider` component in
                    `app/(main)/layout.tsx` when `NEXT_PUBLIC_DEV_MODE_ENABLED=true`. Full Supabase authentication will
                    be integrated in the final epic.
                </snippet>
            </artifact>
            <artifact>
                <path>docs/architecture.md</path>
                <title>Architecture</title>
                <section>ADR 016: Development Mode User Injection</section>
                <snippet>Decision: Implement an `AuthProvider` client component to directly inject a mock user's
                    `user_id` into the session when `NEXT_PUBLIC_DEV_MODE_ENABLED=true` in `app/(main)/layout.tsx`. This
                    allows for direct interaction with Supabase tables using the provided `user_id` for all data
                    operations. Rationale: This strategy allows for seamless feature development and testing without
                    requiring a live Supabase authentication flow, improving developer experience and enabling rapid
                    iteration. It explicitly bypasses Supabase Auth for data operations in development, while Supabase
                    tables are still used as the primary data store. This temporary bypass will be replaced by full
                    Supabase Auth integration in the final epic.
                </snippet>
            </artifact>
            <artifact>
                <path>docs/ux-design-specification.md</path>
                <title>whatcha-doin UX Design Specification</title>
                <section>Executive Summary</section>
                <snippet>For development purposes, Magic Link authentication is temporarily disabled. The application is
                    configured to use a hardcoded test user session for all feature development. This is achieved by
                    injecting a mock user via the `AuthProvider` component in `app/(main)/layout.tsx` when
                    `NEXT_PUBLIC_DEV_MODE_ENABLED=true`.
                </snippet>
            </artifact>
            <artifact>
                <path>docs/epics.md</path>
                <title>whatcha-doin - Epic Breakdown</title>
                <section>Epic 1: Core Application Foundation &amp; Authenticated Root View</section>
                <snippet>Goal: Establish the foundational project infrastructure, implement a development-friendly
                    bypass for Supabase data interaction, and lay out the basic authenticated UI accessible via the
                    user's public profile slug. Scope: Project setup, core infrastructure, development data interaction
                    bypass (mocking Supabase Auth and directly using tables with a hardcoded user ID).
                </snippet>
            </artifact>
            <artifact>
                <path>docs/epics.md</path>
                <title>whatcha-doin - Epic Breakdown</title>
                <section>Story 1.2: Implement Development Login Bypass</section>
                <snippet>As a developer, I want to bypass the full Supabase login flow during local development, So that
                    I can quickly test core features using a predefined user session without repeated logins. Technical
                    Notes: This story requires implementing a mechanism (e.g., environment variable, mock service) to
                    inject a predefined user session. User data will be managed via direct Supabase table interaction
                    using the hardcoded user's `user_id`, bypassing Supabase Authentication for data operations. This
                    temporarily de-prioritizes the full integration of Supabase authentication until the final epic.
                </snippet>
            </artifact>
        </docs>
        <code>
            <artifact>
                <path>components/auth/Auth.tsx</path>
                <kind>component</kind>
                <symbol>Auth</symbol>
                <reason>Existing authentication component that needs conditional rendering.</reason>
            </artifact>
            <artifact>
                <path>components/auth/AuthProvider.tsx</path>
                <kind>component</kind>
                <symbol>AuthProvider</symbol>
                <reason>Component to be created/modified for injecting mock `user_id`.</reason>
            </artifact>
            <artifact>
                <path>components/auth/Logins.tsx</path>
                <kind>component</kind>
                <symbol>Logins</symbol>
                <reason>Existing authentication component that needs conditional rendering.</reason>
            </artifact>
            <artifact>
                <path>app/layout.tsx</path>
                <kind>nextjs-layout</kind>
                <symbol>RootLayout</symbol>
                <reason>Main layout file where `AuthProvider` will be integrated.</reason>
            </artifact>
            <artifact>
                <path>.env.local.example</path>
                <kind>config-file</kind>
                <reason>Needs to be updated with `NEXT_PUBLIC_DEV_MODE_ENABLED` variable.</reason>
            </artifact>
            <artifact>
                <path>README.md</path>
                <kind>documentation</kind>
                <reason>Needs to be updated with `NEXT_PUBLIC_DEV_MODE_ENABLED` variable documentation.</reason>
            </artifact>
            <artifact>
                <path>lib/supabase/client.ts</path>
                <kind>service</kind>
                <reason>Needs to be created/modified to ensure `user_id` is passed correctly to Supabase client.
                </reason>
            </artifact>
        </code>
        <dependencies>
            <ecosystem name="Node.js">
                <package name="class-variance-authority" version="^0.7.1"/>
                <package name="clsx" version="^2.1.1"/>
                <package name="lucide-react" version="^0.554.0"/>
                <package name="next" version="^16.0.3"/>
                <package name="react" version="19.2.0"/>
                <package name="react-dom" version="19.2.0"/>
                <package name="tailwind-merge" version="^3.4.0"/>
                <package name="tailwindcss-animate" version="^1.0.7"/>
                <package name="tw-animate-css" version="^1.4.0"/>
                <package name="zustand" version="^5.0.8"/>
            </ecosystem>
            <ecosystem name="Node.js Dev Dependencies">
                <package name="@tailwindcss/postcss" version="^4"/>
                <package name="@types/node" version="^20"/>
                <package name="@types/react" version="^19"/>
                <package name="@types/react-dom" version="^19"/>
                <package name="babel-plugin-react-compiler" version="1.0.0"/>
                <package name="eslint" version="^9"/>
                <package name="eslint-config-next" version="16.0.3"/>
                <package name="tailwindcss" version="^4"/>
                <package name="typescript" version="^5"/>
            </ecosystem>
        </dependencies>
    </artifacts>

    <constraints>
        <constraint>
            <type>architectural-decision</type>
            <description>ADR 016: Development Mode User Injection - Temporary bypass of Supabase authentication flow for
                local development.
            </description>
        </constraint>
        <constraint>
            <type>technical</type>
            <description>Supabase Interaction: The system should interact with Supabase tables directly using the mock
                `user_id` injected by the `AuthProvider` component. This bypasses the traditional Supabase
                authentication `auth.uid()` context for RLS during development mode. **The bypass test user (mock
                `user_id`) must be able to insert, select, update, and delete data into all respective tables (users,
                habits, habit_completions, todos, journal_entries) while respecting RLS policies defined in
                `supabase/migrations/20251113093152_initial_schema_setup.sql`.**
            </description>
        </constraint>
        <constraint>
            <type>framework</type>
            <description>Next.js App Router: Components and layouts should adhere to Next.js App Router conventions.
            </description>
        </constraint>
        <constraint>
            <type>temporary-solution</type>
            <description>This development bypass is a temporary solution and must be replaced by full Supabase Auth
                integration in Epic 8.
            </description>
        </constraint>
        <constraint>
            <type>testing</type>
            <description>Testing Requirements: Unit tests for `AuthProvider` logic; Integration tests for Supabase
                client with mock `user_id` to verify RLS compliance; E2E tests for authentication UI bypass in
                development mode.
            </description>
        </constraint>
    </constraints>
    <interfaces/>
    <tests>
        <standards>
            Unit testing will use Vitest and React Testing Library, focusing on `AuthProvider` logic. Integration tests
            will use Vitest to verify Supabase client calls with mock `user_id` and RLS compliance. E2E tests will use
            Playwright to ensure authentication UI bypass in development mode. All tests will be integrated into GitHub
            Actions. **All tests must aim for >90% code coverage, covering all scenarios including edge cases.**
        </standards>
        <locations>
            <path>tests/unit/</path>
            <path>tests/integration/</path>
            <path>tests/e2e/</path>
        </locations>
        <ideas>
            <idea ac-id="1,2,3,5">
                <description>Unit tests for `AuthProvider` logic to verify conditional user injection and mock session
                    reflection.
                </description>
            </idea>
            <idea ac-id="3,5">
                <description>Integration tests to verify Supabase client calls correctly use the injected `user_id` and
                    RLS policies are satisfied in development mode.
                </description>
            </idea>
            <idea ac-id="4">
                <description>E2E tests using Playwright to ensure authentication UI components are bypassed or
                    conditionally rendered in development mode.
                </description>
            </idea>
            <idea ac-id="1">
                <description>Manual verification of `NEXT_PUBLIC_DEV_MODE_ENABLED` environment variable usage and its
                    effect on the application.
                </description>
            </idea>
        </ideas>
    </tests>
</story-context>